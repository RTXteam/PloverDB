[uwsgi]

module = app.main
callable = app
uid = plover
gid = plover
buffer-size = 65535
post-buffering = 32768
logto = /var/log/uwsgi.log
max-requests = 100
harakiri = 45
min-worker-lifetime = 5
max-worker-lifetime = 14400
max-worker-lifetime-delta = 60
skip-atexit-teardown = true
skip-atexit = true

# =============================================================================
# REQUIRED ADDITIONS FOR PYTHON 3.12 (migrating from tiangolo python:3.11)
# The tiangolo/uwsgi-nginx-flask image provided these settings automatically.
# With vanilla python:3.12 base image, we must set them explicitly.
# =============================================================================

# Socket: tiangolo used nginx+unix socket internally.
# we restored nginx inside the container (#73) so we use the same unix socket.
# without nginx (http-socket mode), there's no connection buffering and the
# kernel listen backlog fills up under sustained load, causing 504s.
socket = /tmp/uwsgi.sock
chmod-socket = 666

# Master process: required for worker management (tiangolo set this internally)
master = true

# These were set via environment variables in tiangolo; now in start.sh CMD
# processes = 16      (set via: --processes ${UWSGI_PROCESSES:-16} in start.sh)
# cheaper = 8         (set via: --cheaper ${UWSGI_CHEAPER:-8} in start.sh)

# --- Overload protection (#73) ---
# log which uri harakiri kills so we can identify slow queries
harakiri-verbose = true
# suppress "OSError: write error" tracebacks when clients disconnect early
disable-write-exception = true
# serialize accept() to avoid thundering-herd on idle workers
thunder-lock = true

# Graceful shutdown (from tiangolo's uwsgi.ini)
die-on-term = true
need-app = true
